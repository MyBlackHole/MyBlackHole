# count

计算剩余量

```sql
sql = "select * from oceanbase.__all_virtual_server_stat;"
+----------------+----------+-------+-----------+--------------+----------------------+-------------+--------------+----------------------+--------------+---------------+-----------------------+----------+--------------------+----------------+--------------+--------------------+---------------------+--------------------+-------------+----+------------+-------------------------------------------------------------------------------------------+------------------+---------------------+-----------------------+--------------------+-------------------+-----------+----------------------+--------------+------------------+-----------------+----------------+------------+-------------+-----------------+-------------------+-------------------+--------------+------------------+--------------+------------------+----------------------+
| svr_ip         | svr_port | zone  | cpu_total | cpu_assigned | cpu_assigned_percent | mem_total   | mem_assigned | mem_assigned_percent | disk_total   | disk_assigned | disk_assigned_percent | unit_num | migrating_unit_num | merged_version | leader_count | load               | cpu_weight          | memory_weight      | disk_weight | id | inner_port | build_version                                                                             | register_time    | last_heartbeat_time | block_migrate_in_time | start_service_time | last_offline_time | stop_time | force_stop_heartbeat | admin_status | heartbeat_status | with_rootserver | with_partition | mem_in_use | disk_in_use | clock_deviation | heartbeat_latency | clock_sync_status | cpu_capacity | cpu_max_assigned | mem_capacity | mem_max_assigned | ssl_key_expired_time |
+----------------+----------+-------+-----------+--------------+----------------------+-------------+--------------+----------------------+--------------+---------------+-----------------------+----------+--------------------+----------------+--------------+--------------------+---------------------+--------------------+-------------+----+------------+-------------------------------------------------------------------------------------------+------------------+---------------------+-----------------------+--------------------+-------------------+-----------+----------------------+--------------+------------------+-----------------+----------------+------------+-------------+-----------------+-------------------+-------------------+--------------+------------------+--------------+------------------+----------------------+
| 192.168.80.143 | 2882     | zone1 | 12.0      | 7.5          | 62                   | 19327352832 | 15569256448  | 80                   | 320902004736 | 232176293888  | 72                    | 3        | 0                  | 24             | 1436         | 0.7191418071768267 | 0.47859922178988323 | 0.5214007782101168 | 0.0         | 1  | 2881       | 3.2.3.3_107000092023011911-7699b9a5504eec15ff5ef1f2a95e60136802b170(Jan 19 2023 11:29:19) | 0                | 1698311253214311    | 0                     | 1697424882030617   | 0                 | 0         | 0                    | NORMAL       | alive            | 1               | 1              | 0          | 287309824   | -31             | 342               | SYNC              | 12.0         | 12.0             | 19327352832  | 16535624089      | 0                    |
| 192.168.80.144 | 2882     | zone2 | 12.0      | 6.5          | 54                   | 19327352832 | 10200547328  | 52                   | 320902004736 | 231639422976  | 72                    | 2        | 0                  | 24             | 149          | 0.5344249891915261 | 0.47859922178988323 | 0.5214007782101168 | 0.0         | 2  | 2881       | 3.2.3.3_107000092023011911-7699b9a5504eec15ff5ef1f2a95e60136802b170(Jan 19 2023 11:29:19) | 1697426725713672 | 1698311251947031    | 0                     | 1697424881638323   | 0                 | 0         | 0                    | NORMAL       | alive            | 0               | 1              | 0          | 289406976   | -1205           | 918               | SYNC              | 12.0         |  9.0             | 19327352832  | 11166914969      | 0                    |
| 192.168.80.145 | 2882     | zone3 | 12.0      | 6.5          | 54                   | 19327352832 | 10200547328  | 52                   | 320902004736 | 221438875648  | 69                    | 2        | 0                  | 24             | 0            | 0.5344249891915261 | 0.47859922178988323 | 0.5214007782101168 | 0.0         | 3  | 2881       | 3.2.3.3_107000092023011911-7699b9a5504eec15ff5ef1f2a95e60136802b170(Jan 19 2023 11:29:19) | 1697426725713917 | 1698311253466529    | 0                     | 1697424881650543   | 0                 | 0         | 0                    | NORMAL       | alive            | 0               | 1              | 0          | 243269632   | -1200           | 749               | SYNC              | 12.0         |  9.0             | 19327352832  | 11166914969      | 0                    |
+----------------+----------+-------+-----------+--------------+----------------------+-------------+--------------+----------------------+--------------+---------------+-----------------------+----------+--------------------+----------------+--------------+--------------------+---------------------+--------------------+-------------+----+------------+-------------------------------------------------------------------------------------------+------------------+---------------------+-----------------------+--------------------+-------------------+-----------+----------------------+--------------+------------------+-----------------+----------------+------------+-------------+-----------------+-------------------+-------------------+--------------+------------------+--------------+------------------+----------------------+


zone_max_malloc as zmm
    zone_x: (mem_total, disk_total, cpu_total)



sql = "select * from oceanbase.gv$unit;"
"""
+---------+----------------+------------------+------------------+--------------------+-------+-----------+--------------------+----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| unit_id | unit_config_id | unit_config_name | resource_pool_id | resource_pool_name | zone  | tenant_id | tenant_name        | svr_ip         | svr_port | migrate_from_svr_ip | migrate_from_svr_port | max_cpu | min_cpu | max_memory | min_memory | max_iops | min_iops | max_disk_size | max_session_num     |
+---------+----------------+------------------+------------------+--------------------+-------+-----------+--------------------+----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| 3       | 1              | sys_unit_config  | 1                | sys_pool           | zone3 | 1         | sys                | 192.168.80.145 | 2882     |                     | 0                     | 5.0     | 2.5     | 5798205849 | 4831838208 | 10000    | 5000     | 220902004736  | 9223372036854775807 |
| 2       | 1              | sys_unit_config  | 1                | sys_pool           | zone2 | 1         | sys                | 192.168.80.144 | 2882     |                     | 0                     | 5.0     | 2.5     | 5798205849 | 4831838208 | 10000    | 5000     | 220902004736  | 9223372036854775807 |
| 1       | 1              | sys_unit_config  | 1                | sys_pool           | zone1 | 1         | sys                | 192.168.80.143 | 2882     |                     | 0                     | 5.0     | 2.5     | 5798205849 | 4831838208 | 10000    | 5000     | 220902004736  | 9223372036854775807 |
| 1001    | 1001           | unit1            | 1001             | pool1              | zone1 | 1001      | tenant1_1698215702 | 192.168.80.143 | 2882     |                     | 0                     | 4.0     | 4.0     | 5368709120 | 5368709120 | 128      | 128      | 10737418240   | 64                  |
| 1002    | 1001           | unit1            | 1002             | pool2              | zone2 | 1002      | tenant2_1698215702 | 192.168.80.144 | 2882     |                     | 0                     | 4.0     | 4.0     | 5368709120 | 5368709120 | 128      | 128      | 10737418240   | 64                  |
| 1004    | 1003           | config_pool3_pyq | 1020             | pool_gzz           | zone1 | <null>    | <null>             | 192.168.80.143 | 2882     |                     | 0                     | 3.0     | 1.0     | 5368709120 | 5368709120 | 128      | 128      | 536870912     | 64                  |
| 1003    | 1004           | config_pool3_dac | 1011             | pool_pool3_gzz     | zone3 | <null>    | <null>             | 192.168.80.145 | 2882     |                     | 0                     | 4.0     | 4.0     | 5368709120 | 5368709120 | 128      | 128      | 536870912     | 64                  |
+---------+----------------+------------------+------------------+--------------------+-------+-----------+--------------------+----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
"""


zone_malloc as zm (排除 tenant_id == NULL )
    zone_x: group(zone)(sum(max_cpu), sum(max_memory), sum(max_disk_size))



zone_free_malloc
    zone_x: (free_mem: (zmm.zone_x.mem_total - zm.zone_x.max_memory), free_cpu: (zmm.zone_x.cpu_total - zm.zone_x.max_cpu), free_disk: (zmm.zone_x.disk_total - zm.zone_x.max_disk_size))
```


- 案例
```shell
select * from oceanbase.__all_virtual_server_stat;
+-----------------+----------+-------+-----------+--------------+----------------------+-------------+--------------+----------------------+--------------+---------------+-----------------------+----------+--------------------+----------------+--------------+---------------------+---------------------+--------------------+-------------+----+------------+-------------------------------------------------------------------------------------------+------------------+---------------------+-----------------------+--------------------+-------------------+-----------+----------------------+--------------+------------------+-----------------+----------------+------------+-------------+-----------------+-------------------+-------------------+--------------+------------------+--------------+------------------+----------------------+
| svr_ip          | svr_port | zone  | cpu_total | cpu_assigned | cpu_assigned_percent | mem_total   | mem_assigned | mem_assigned_percent | disk_total   | disk_assigned | disk_assigned_percent | unit_num | migrating_unit_num | merged_version | leader_count | load                | cpu_weight          | memory_weight      | disk_weight | id | inner_port | build_version                                                                             | register_time    | last_heartbeat_time | block_migrate_in_time | start_service_time | last_offline_time | stop_time | force_stop_heartbeat | admin_status | heartbeat_status | with_rootserver | with_partition | mem_in_use | disk_in_use | clock_deviation | heartbeat_latency | clock_sync_status | cpu_capacity | cpu_max_assigned | mem_capacity | mem_max_assigned | ssl_key_expired_time |
+-----------------+----------+-------+-----------+--------------+----------------------+-------------+--------------+----------------------+--------------+---------------+-----------------------+----------+--------------------+----------------+--------------+---------------------+---------------------+--------------------+-------------+----+------------+-------------------------------------------------------------------------------------------+------------------+---------------------+-----------------------+--------------------+-------------------+-----------+----------------------+--------------+------------------+-----------------+----------------+------------+-------------+-----------------+-------------------+-------------------+--------------+------------------+--------------+------------------+----------------------+
| 192.168.110.148 | 2882     | zone1 | 12.0      | 2.5          | 20                   | 12884901888 | 3221225472   | 25                   | 320902004736 | 320902004736  | 100                   | 1        | 0                  | 0              | 1287         | 0.23106060606060605 | 0.45454545454545453 | 0.5454545454545454 | 0.0         | 1  | 2881       | 3.2.3.3_107000092023011911-7699b9a5504eec15ff5ef1f2a95e60136802b170(Jan 19 2023 11:29:19) | 0                | 1711676798509331    | 0                     | 1708952117170636   | 0                 | 0         | 0                    | NORMAL       | alive            | 1               | 1              | 0          | 262144000   | -35             | 351               | SYNC              | 12.0         | 5.0              | 12884901888  | 3865470566       | 0                    |
| 192.168.110.149 | 2882     | zone2 | 12.0      | 2.5          | 20                   | 12884901888 | 3221225472   | 25                   | 320902004736 | 320902004736  | 100                   | 1        | 0                  | 0              | 0            | 0.23106060606060605 | 0.45454545454545453 | 0.5454545454545454 | 0.0         | 2  | 2881       | 3.2.3.3_107000092023011911-7699b9a5504eec15ff5ef1f2a95e60136802b170(Jan 19 2023 11:29:19) | 1711676298129534 | 1711676798483483    | 0                     | 1708952117186870   | 0                 | 0         | 0                    | NORMAL       | alive            | 0               | 1              | 0          | 249561088   | 441             | 596               | SYNC              | 12.0         | 5.0              | 12884901888  | 3865470566       | 0                    |
| 192.168.110.150 | 2882     | zone3 | 12.0      | 2.5          | 20                   | 12884901888 | 3221225472   | 25                   | 320902004736 | 320902004736  | 100                   | 1        | 0                  | 0              | 0            | 0.23106060606060605 | 0.45454545454545453 | 0.5454545454545454 | 0.0         | 3  | 2881       | 3.2.3.3_107000092023011911-7699b9a5504eec15ff5ef1f2a95e60136802b170(Jan 19 2023 11:29:19) | 1711676298130025 | 1711676798132895    | 0                     | 1708952123100445   | 0                 | 0         | 0                    | NORMAL       | alive            | 0               | 1              | 0          | 249561088   | 223             | 551               | SYNC              | 12.0         | 5.0              | 12884901888  | 3865470566       | 0                    |
+-----------------+----------+-------+-----------+--------------+----------------------+-------------+--------------+----------------------+--------------+---------------+-----------------------+----------+--------------------+----------------+--------------+---------------------+---------------------+--------------------+-------------+----+------------+-------------------------------------------------------------------------------------------+------------------+---------------------+-----------------------+--------------------+-------------------+-----------+----------------------+--------------+------------------+-----------------+----------------+------------+-------------+-----------------+-------------------+-------------------+--------------+------------------+--------------+------------------+----------------------+
select zone, cpu_total, mem_total, disk_total from oceanbase.__all_virtual_server_stat;
+-------+-----------+-------------+--------------+
| zone  | cpu_total | mem_total   | disk_total   |
+-------+-----------+-------------+--------------+
| zone1 | 12.0      | 12884901888 | 320902004736 |
| zone2 | 12.0      | 12884901888 | 320902004736 |
| zone3 | 12.0      | 12884901888 | 320902004736 |
+-------+-----------+-------------+--------------+

select * from oceanbase.__all_virtual_disk_stat;

+-----------------+----------+--------------+-----------+--------------+---------------+---------------------+
| svr_ip          | svr_port | total_size   | used_size | free_size    | is_disk_valid | disk_error_begin_ts |
+-----------------+----------+--------------+-----------+--------------+---------------+---------------------+
| 192.168.110.148 | 2882     | 320902004736 | 262144000 | 320635666432 | 1             | 0                   |
| 192.168.110.150 | 2882     | 320902004736 | 249561088 | 320648249344 | 1             | 0                   |
| 192.168.110.149 | 2882     | 320902004736 | 249561088 | 320648249344 | 1             | 0                   |
+-----------------+----------+--------------+-----------+--------------+---------------+---------------------+

select * from oceanbase.gv$unit;
+---------+----------------+------------------+------------------+--------------------+-------+-----------+-------------+-----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| unit_id | unit_config_id | unit_config_name | resource_pool_id | resource_pool_name | zone  | tenant_id | tenant_name | svr_ip          | svr_port | migrate_from_svr_ip | migrate_from_svr_port | max_cpu | min_cpu | max_memory | min_memory | max_iops | min_iops | max_disk_size | max_session_num     |
+---------+----------------+------------------+------------------+--------------------+-------+-----------+-------------+-----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| 1       | 1              | sys_unit_config  | 1                | sys_pool           | zone1 | 1         | sys         | 192.168.110.148 | 2882     |                     | 0                     | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 320902004736  | 9223372036854775807 |
| 2       | 1              | sys_unit_config  | 1                | sys_pool           | zone2 | 1         | sys         | 192.168.110.149 | 2882     |                     | 0                     | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 320902004736  | 9223372036854775807 |
| 3       | 1              | sys_unit_config  | 1                | sys_pool           | zone3 | 1         | sys         | 192.168.110.150 | 2882     |                     | 0                     | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 320902004736  | 9223372036854775807 |
+---------+----------------+------------------+------------------+--------------------+-------+-----------+-------------+-----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+

CREATE RESOURCE UNIT unit1 MAX_CPU 4, MIN_CPU=4, MIN_MEMORY= '5G', MAX_MEMORY '5G', MAX_IOPS 128,MAX_DISK_SIZE '10G', MAX_SESSION_NUM 64,MIN_IOPS=128;
<!-- DROP RESOURCE UNIT unit1; -->

SELECT * FROM oceanbase.__all_unit_config;
+----------------------------+----------------------------+----------------+-----------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| gmt_create                 | gmt_modified               | unit_config_id | name            | max_cpu | min_cpu | max_memory | min_memory | max_iops | min_iops | max_disk_size | max_session_num     |
+----------------------------+----------------------------+----------------+-----------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| 2023-04-14 17:45:56.758381 | 2024-03-28 18:56:57.201599 | 1              | sys_unit_config | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 320902004736  | 9223372036854775807 |
| 2024-03-28 17:49:38.788220 | 2024-03-28 17:49:38.788220 | 1010           | config_2222_ixi | 1.0     | 1.0     | 5368709120 | 5368709120 | 128      | 128      | 536870912     | 64                  |
| 2024-03-29 09:58:23.534229 | 2024-03-29 09:58:23.534229 | 1011           | unit1           | 4.0     | 4.0     | 5368709120 | 5368709120 | 128      | 128      | 10737418240   | 64                  |
+----------------------------+----------------------------+----------------+-----------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+

SELECT * FROM oceanbase.__all_resource_pool;
+----------------------------+----------------------------+------------------+----------+------------+----------------+-------------------+-----------+--------------+--------------------+
| gmt_create                 | gmt_modified               | resource_pool_id | name     | unit_count | unit_config_id | zone_list         | tenant_id | replica_type | is_tenant_sys_pool |
+----------------------------+----------------------------+------------------+----------+------------+----------------+-------------------+-----------+--------------+--------------------+
| 2023-04-14 17:45:56.762186 | 2023-04-14 17:45:56.774081 | 1                | sys_pool | 1          | 1              | zone1;zone2;zone3 | 1         | 0            | 0                  |
+----------------------------+----------------------------+------------------+----------+------------+----------------+-------------------+-----------+--------------+--------------------+

CREATE RESOURCE POOL pool1 UNIT='unit1',UNIT_NUM=1,ZONE_LIST=('zone2');
<!-- DROP RESOURCE POOL pool1; -->

CREATE RESOURCE POOL pool1 UNIT='unit1',UNIT_NUM=1,ZONE_LIST=('zone2');
(4624, " machine resource 'zone2' is not enough to hold a new unit")

<!-- 320902004736 - 10737418240 = 310164586496 -->
alter resource unit sys_unit_config max_disk_size=310164586496;
+---------+----------------+------------------+------------------+--------------------+-------+-----------+-------------+-----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| unit_id | unit_config_id | unit_config_name | resource_pool_id | resource_pool_name | zone  | tenant_id | tenant_name | svr_ip          | svr_port | migrate_from_svr_ip | migrate_from_svr_port | max_cpu | min_cpu | max_memory | min_memory | max_iops | min_iops | max_disk_size | max_session_num     |
+---------+----------------+------------------+------------------+--------------------+-------+-----------+-------------+-----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
| 1       | 1              | sys_unit_config  | 1                | sys_pool           | zone1 | 1         | sys         | 192.168.110.148 | 2882     |                     | 0                     | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 310164586496  | 9223372036854775807 |
| 2       | 1              | sys_unit_config  | 1                | sys_pool           | zone2 | 1         | sys         | 192.168.110.149 | 2882     |                     | 0                     | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 310164586496  | 9223372036854775807 |
| 3       | 1              | sys_unit_config  | 1                | sys_pool           | zone3 | 1         | sys         | 192.168.110.150 | 2882     |                     | 0                     | 5.0     | 2.5     | 3865470566 | 3221225472 | 10000    | 5000     | 310164586496  | 9223372036854775807 |
+---------+----------------+------------------+------------------+--------------------+-------+-----------+-------------+-----------------+----------+---------------------+-----------------------+---------+---------+------------+------------+----------+----------+---------------+---------------------+
```
