# redo

重做

## 核心目标

崩溃恢复: 在数据库异常崩溃后，通过重放 WAL 日志将数据恢复到一致状态。
数据持久化: 确保已提交的事务修改不会丢失。
物理逻辑重做: 基于物理页(Page)操作，但日志内容包含逻辑信息(如行数据)。


## 定义

redo 操作记录了事务对数据库所做的所有修改。这些记录存储在重做日志(Redo Log)中。

## 作用

事务持久性: 确保事务在提交后，即使数据库发生故障，也能够恢复到事务提交后的状态。
恢复机制: 在数据库故障恢复时，重做日志中的记录可以被用来重新应用对数据库的修改，使数据库恢复到故障前的状态。
工作原理:

当事务对数据库进行修改时，数据库会将这些修改记录写入重做日志。
事务提交后，这些重做日志记录会被写入磁盘，以确保事务的持久性。
如果数据库发生故障，重启后可以通过重做日志重新应用这些记录，恢复数据库。


## postgresql 崩溃恢复


```
graph LR
    A[启动数据库] --> B[读取pg_control文件]
    B --> C{检查是否需要恢复}
    C -- 是 --> D[定位REDO起点：最新检查点LSN]
    D --> E[从检查点LSN开始扫描WAL]
    E --> F[重放WAL记录]
    F --> G[更新数据页的pd_lsn]
    G --> H[达到WAL末尾]
    H --> I[重置事务状态]
    I --> J[数据库恢复完成]
```

```
场景：
  1. 事务T1： INSERT 行A → 生成WAL记录 LSN=0/2000000
  2. 事务T2： UPDATE 行B → 生成WAL记录 LSN=0/2000100
  3. 检查点： 将脏页刷盘，记录 LSN=0/2000100 到 pg_control
  4. 事务T3： DELETE 行C → 生成WAL记录 LSN=0/2000200 → 未刷盘时崩溃

恢复过程：
  - 从检查点 LSN=0/2000100 开始扫描WAL
  - 重放 LSN=0/2000200（DELETE行C），因为数据页的pd_lsn < 0/2000200
  - 跳过 LSN=0/2000000 和 0/2000100（因pd_lsn ≥ 这些值）
```

# 总结

PostgreSQL 的 REDO 机制通过以下设计保证可靠性：
WAL 先行: 所有修改先写日志，后写数据页。
LSN 追踪: 通过日志序列号精确控制恢复范围。
检查点锚点: 定期建立恢复起点，减少扫描量。
物理逻辑重做: 结合页面物理操作与行级逻辑信息，高效恢复。
此机制确保了在任何崩溃场景下，已提交事务不丢失，未提交事务自动回滚，是数据库 ACID 特性的基石。
