# targetcli
iscsi 客户端工具
![[imgs/Pasted image 20230525215751.png]]

## ubuntu install
```shell
sudo apt-get install targetcli-fb
```

## 使用 
```shell
sudo targetcli

类文件系统操作
```

- 创建 iscsi 磁盘
```shell
/> ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 0]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 0]
  o- loopback ......................................................................................................... [Targets: 0]
  o- vhost ............................................................................................................ [Targets: 0]
/> /backstores/block create  idisk2 /dev/sdb  
```

-  通过 img 创建 iscsi 磁盘
```shell
/> ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 0]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 0]
  o- loopback ......................................................................................................... [Targets: 0]
  o- vhost ............................................................................................................ [Targets: 0]
/> /backstores/fileio create idisk3 /opt/disk.img
Created fileio idisk3 with size 536870912
```

- 创建服务端程序
```shell
/> ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 1]
  | | o- idisk3 .................................................................. [/opt/disk.img (512.0MiB) write-back deactivated]
  | |   o- alua ................................................................................................... [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 0]
  o- loopback ......................................................................................................... [Targets: 0]
  o- vhost ............................................................................................................ [Targets: 0]
/> iscsi/ create iqn.2023-05.black.com:server
Created target iqn.2023-05.black.com:server.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.
```

- 进入服务端程序,创建服务卷 backstores/block/idisk2  
```shell
/> ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 1]
  | | o- idisk3 .................................................................. [/opt/disk.img (512.0MiB) write-back deactivated]
  | |   o- alua ................................................................................................... [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 1]
  | o- iqn.2023-05.black.com:server ...................................................................................... [TPGs: 1]
  |   o- tpg1 ............................................................................................... [no-gen-acls, no-auth]
  |     o- acls .......................................................................................................... [ACLs: 0]
  |     o- luns .......................................................................................................... [LUNs: 0]
  |     o- portals .................................................................................................... [Portals: 1]
  |       o- 0.0.0.0:3260 ..................................................................................................... [OK]
  o- loopback ......................................................................................................... [Targets: 0]
  o- vhost ............................................................................................................ [Targets: 0]
/> cd iscsi/iqn.2023-05.black.com:server/tpg1/
/iscsi/iqn.20...m:server/tpg1> luns/ create /backstores/fileio/idisk3
Created LUN 0.
/iscsi/iqn.20...m:server/tpg1> ls
o- tpg1 ..................................................................................................... [no-gen-acls, no-auth]
  o- acls ................................................................................................................ [ACLs: 0]
  o- luns ................................................................................................................ [LUNs: 1]
  | o- lun0 ..................................................................... [fileio/idisk3 (/opt/disk.img) (default_tg_pt_gp)]
  o- portals .......................................................................................................... [Portals: 1]
    o- 0.0.0.0:3260 ........................................................................................................... [OK]
```

- 创建客户端连接器
```shell
/iscsi/iqn.20...m:server/tpg1> acls/ create iqn.2023-05.black.com:client
Created Node ACL for iqn.2023-05.black.com:client
Created mapped LUN 0.
/iscsi/iqn.20...m:server/tpg1> ls
o- tpg1 ..................................................................................................... [no-gen-acls, no-auth]
  o- acls ................................................................................................................ [ACLs: 1]
  | o- iqn.2023-05.black.com:client ............................................................................... [Mapped LUNs: 1]
  |   o- mapped_lun0 ..................................................................................... [lun0 fileio/idisk3 (rw)]
  o- luns ................................................................................................................ [LUNs: 1]
  | o- lun0 ..................................................................... [fileio/idisk3 (/opt/disk.img) (default_tg_pt_gp)]
  o- portals .......................................................................................................... [Portals: 1]
    o- 0.0.0.0:3260 ........................................................................................................... [OK]
```

- 创建用户密码
```shell
/iscsi/iqn.20...m:server/tpg1> ls
o- tpg1 ..................................................................................................... [no-gen-acls, no-auth]
  o- acls ................................................................................................................ [ACLs: 1]
  | o- iqn.2023-05.black.com:client ............................................................................... [Mapped LUNs: 1]
  |   o- mapped_lun0 ..................................................................................... [lun0 fileio/idisk3 (rw)]
  o- luns ................................................................................................................ [LUNs: 1]
  | o- lun0 ..................................................................... [fileio/idisk3 (/opt/disk.img) (default_tg_pt_gp)]
  o- portals .......................................................................................................... [Portals: 1]
    o- 0.0.0.0:3260 ........................................................................................................... [OK]
/iscsi/iqn.20...m:server/tpg1> cd acls/iqn.2023-05.black.com:client/
/iscsi/iqn.20...ck.com:client> set auth userid=black
Parameter userid is now 'black'.
/iscsi/iqn.20...ck.com:client> set auth password=1358
Parameter password is now '1358'.

/iscsi/iqn.20...ck.com:client> cd /
/> ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 1]
  | | o- idisk3 .................................................................... [/opt/disk.img (512.0MiB) write-back activated]
  | |   o- alua ................................................................................................... [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 1]
  | o- iqn.2023-05.black.com:server ...................................................................................... [TPGs: 1]
  |   o- tpg1 ............................................................................................... [no-gen-acls, no-auth]
  |     o- acls .......................................................................................................... [ACLs: 1]
  |     | o- iqn.2023-05.black.com:client ......................................................................... [Mapped LUNs: 1]
  |     |   o- mapped_lun0 ............................................................................... [lun0 fileio/idisk3 (rw)]
  |     o- luns .......................................................................................................... [LUNs: 1]
  |     | o- lun0 ............................................................... [fileio/idisk3 (/opt/disk.img) (default_tg_pt_gp)]
  |     o- portals .................................................................................................... [Portals: 1]
  |       o- 0.0.0.0:3260 ..................................................................................................... [OK]
  o- loopback ......................................................................................................... [Targets: 0]
  o- vhost ............................................................................................................ [Targets: 0]
```


- 配置 initiator, 测试发现, 测试登陆, 测试 mount，测试取消登陆
```shell
sudo nvim /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.2023-05.black.com:client

sudo nvim /etc/iscsi/iscsid.conf
node.session.auth.authmethod = CHAP
node.session.auth.username = black
node.session.auth.password = 1358

sudo systemctl restart iscsid

# 发现
sudo iscsiadm -m discovery -t sendtargets -p 192.168.100.179
192.168.100.179:3260,1 iqn.2023-05.black.com:server

# 登陆
sudo iscsiadm -m node -T iqn.2023-05.black.com:server -p 192.168.100.179 -l

mount /dev/sdc /mnt/usb/
umount -l /dev/sdc

# 取消登陆
[root@jbjb iscsi]# iscsiadm -m node -T iqn.2023-05.black.com:server -p 192.168.100.179 -u 

# 创建文件系统
sudo mkfs.ext4 /dev/sdb
```
