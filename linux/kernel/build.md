# build

## help
```shell
make help

Cleaning targets:
  clean           - Remove most generated files but keep the config and
                    enough build support to build external modules
  mrproper        - Remove all generated files + config + various backup files
  distclean       - mrproper + remove editor backup and patch files

Configuration targets:
  config          - Update current config utilising a line-oriented program
  nconfig         - Update current config utilising a ncurses menu based program
  menuconfig      - Update current config utilising a menu based program
  xconfig         - Update current config utilising a QT based front-end
  gconfig         - Update current config utilising a GTK based front-end
  oldconfig       - Update current config utilising a provided .config as base
  localmodconfig  - Update current config disabling modules not loaded
  localyesconfig  - Update current config converting local mods to core
  silentoldconfig - Same as oldconfig, but quietly, additionally update deps
  defconfig       - New config with default from ARCH supplied defconfig
  savedefconfig   - Save current config as ./defconfig (minimal config)
  allnoconfig     - New config where all options are answered with no
  allyesconfig    - New config where all options are accepted with yes
  allmodconfig    - New config selecting modules when possible
  alldefconfig    - New config with all symbols set to default
  randconfig      - New config with random answer to all options
  listnewconfig   - List new options
  olddefconfig    - Same as silentoldconfig but sets new symbols to their default value
  kvmconfig       - Enable additional options for guest kernel support
  tinyconfig      - Configure the tiniest possible kernel

Other generic targets:
  all             - Build all targets marked with [*]
* vmlinux         - Build the bare kernel
* modules         - Build all modules
  modules_install - Install all modules to INSTALL_MOD_PATH (default: /)
  firmware_install- Install all firmware to INSTALL_FW_PATH
                    (default: $(INSTALL_MOD_PATH)/lib/firmware)
  dir/            - Build all files in dir and below
  dir/file.[oisS] - Build specified target only
  dir/file.lst    - Build specified mixed source/assembly target only
                    (requires a recent binutils and recent build (System.map))
  dir/file.ko     - Build module including final link
  modules_prepare - Set up for building external modules
  tags/TAGS       - Generate tags file for editors
  cscope          - Generate cscope index
  gtags           - Generate GNU GLOBAL index
  kernelrelease   - Output the release version string (use with make -s)
  kernelversion   - Output the version stored in Makefile (use with make -s)
  image_name      - Output the image name (use with make -s)
  headers_install - Install sanitised kernel headers to INSTALL_HDR_PATH
                    (default: ./usr)

Static analysers
  checkstack      - Generate a list of stack hogs
  namespacecheck  - Name space analysis on compiled kernel
  versioncheck    - Sanity check on version.h usage
  includecheck    - Check for duplicate included header files
  export_report   - List the usages of all exported symbols
  headers_check   - Sanity check on exported headers
  headerdep       - Detect inclusion cycles in headers
  coccicheck      - Check with Coccinelle.

Kernel selftest
  kselftest       - Build and run kernel selftest (run as root)
                    Build, install, and boot kernel before
                    running kselftest on it

Kernel packaging:
  rpm-pkg             - Build both source and binary RPM kernel packages
  binrpm-pkg          - Build only the binary kernel package
  deb-pkg             - Build the kernel as a deb package
  tar-pkg             - Build the kernel as an uncompressed tarball
  targz-pkg           - Build the kernel as a gzip compressed tarball
  tarbz2-pkg          - Build the kernel as a bzip2 compressed tarball
  tarxz-pkg           - Build the kernel as a xz compressed tarball
  perf-tar-src-pkg    - Build perf-3.19.0.tar source tarball
  perf-targz-src-pkg  - Build perf-3.19.0.tar.gz source tarball
  perf-tarbz2-src-pkg - Build perf-3.19.0.tar.bz2 source tarball
  perf-tarxz-src-pkg  - Build perf-3.19.0.tar.xz source tarball

Documentation targets:
 Linux kernel internal documentation in different formats:
  htmldocs        - HTML
  pdfdocs         - PDF
  psdocs          - Postscript
  xmldocs         - XML DocBook
  mandocs         - man pages
  installmandocs  - install man pages generated by mandocs
  cleandocs       - clean all generated DocBook files

Architecture specific targets (x86):
* bzImage      - Compressed kernel image (arch/x86/boot/bzImage)
  install      - Install kernel using
                  (your) ~/bin/installkernel or
                  (distribution) /sbin/installkernel or
                  install to $(INSTALL_PATH) and run lilo
  fdimage      - Create 1.4MB boot floppy image (arch/x86/boot/fdimage)
  fdimage144   - Create 1.4MB boot floppy image (arch/x86/boot/fdimage)
  fdimage288   - Create 2.8MB boot floppy image (arch/x86/boot/fdimage)
  isoimage     - Create a boot CD-ROM image (arch/x86/boot/image.iso)
                  bzdisk/fdimage*/isoimage also accept:
                  FDARGS="..."  arguments for the booted kernel
                  FDINITRD=file initrd for the booted kernel

  i386_defconfig           - Build for i386
  x86_64_defconfig         - Build for x86_64

  make V=0|1 [targets] 0 => quiet build (default), 1 => verbose build
  make V=2   [targets] 2 => give reason for rebuild of target
  make O=dir [targets] Locate all output files in "dir", including .config
  make C=1   [targets] Check all c source with $CHECK (sparse by default)
  make C=2   [targets] Force check of all c source with $CHECK
  make RECORDMCOUNT_WARN=1 [targets] Warn about ignored mcount sections
  make W=n   [targets] Enable extra gcc checks, n=1,2,3 where
                1: warnings which may be relevant and do not occur too often
                2: warnings which occur quite often but may still be relevant
                3: more obscure warnings, can most likely be ignored
                Multiple levels can be combined with W=12 or W=123

Execute "make" or "make all" to build all targets marked with [*]
For further info see the ./README file
```

## config
```shell
make config - 纯文本界面 (最常用的选择)。 
make menuconfig - 基于文本彩色菜单和单选列表。这个选项可以加快开发者开发速度。需要安装ncurses(ncurses-devel)。 
make nconfig - 基于文本的彩色菜单。需要安装curses (libcdk5-dev)。 
make xconfig - QT/X-windows 界面。需要安装QT。 
make gconfig - Gtk/X-windows 界面。需要安装GTK。 
make oldconfig - 纯文本界面，但是其默认的问题是基于已有的本地配置文件。 
make silentoldconfig - 和oldconfig相似，但是不会显示配置文件中已有的问题的回答。 
make olddefconfig -和silentoldconfig相似，但有些问题已经以它们的默认值选择。 
make defconfig - 这个选项将会创建一份以当前系统架构为基础的默认设置文件。 
make ${PLATFORM}defconfig - 创建一份使用arch/$ARCH/configs/${PLATFORM}defconfig中的值的配置文件。 
make allyesconfig - 这个选项将会创建一份尽可能多的问题回答都为‘yes’的配置文件。 
make allmodconfig - 这个选项将会创建一份将尽可能多的内核部分配置为模块的配置文件。

make allnoconfig - 这个选项只会生成内核所必要代码的配置文件。它对尽可能多的问题都回答no。这有时会导致内核无法工作在为编译该内核的硬件上。 
make randconfig - 这个选项会对内核选项随机选择。 
make localmodconfig - 这个选项会根据当前已加载模块列表和系统配置来生成配置文件。 
make localyesconfig - 将所有可装载模块（LKM）都编译进内核(
```

```shell
/home/black/aio-data/linux-4.19.315
cd /home/black/aio-data && wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.315.tar.xz
tar -xf linux-4.19.315.tar.xz # 解压源码
<!-- #安装编译环境和依赖库 -->
<!-- paru -S libncurses-dev flex bison bc openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf gcc make gnu-standards libtool gettext -->

cd linux-4.19.315 # 进入源码目录
# 生成基于文本界面的内核配置菜单,该操作依赖ncurses库
# 当出现’Your display is too small to run Menuconfig!‘提示时,将终端放大重新执行这条命令即可
make menuconf
## 配置开启KGDB参数,然后光标选择save,将选项保存到.config文件中
## Kernel hacking --->
##    Compile-time checks and compiler options --->
##        [*] Compile the kernel with debug info
##        [*] Provide GDB scripts for kernel debugging
##    Generic Kernel Debugging Instruments --->
##        [*] KGDB: kernel debugger
## General setup  --->  
##     [*] Configure standard kernel features (expert users)  --->
##         （选中此项，才有/proc/kallsyms接口文件, oops问题，选中此选项即可，子选项可以忽略）
##         [*]   Load all symbols for debugging/ksymoops 
##               [*]   Include all symbols in kallsyms
##               [*]   Do an extra kallsyms pass  
## 

Kernel hacking
--> Compile-time checks and compiler options
    --> [*] Provide GDB scripts for kernel debugging
    --> [*] Enable full Section mismatch analysis
    --> Debug information (Rely on the toolchain's implicit default DWARF version)

CONFIG_KGDB=y
CONFIG_DEBUG_BUGVERBOSE=y
CONFIG_DEBUG_SECTION_MISMATCH=y  # 防止内联
CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y  # 新版本特性
CONFIG_DEBUG_KERNEL=y
CONFIG_FRAME_POINTER=y  # Makefile中选择GCC编译选项
CONFIG_GDB_SCRIPTS=y  # gdb python
CONFIG_EFI_PARTITION=y

make -j $(nproc)   # 进行编译,此处nproc变量为cpu核心的个数


❯ ls -alh arch/x86_64/boot/bzImage
Permissions Size User  Date Modified Name
lrwxrwxrwx     - black 11 Jun 14:54   arch/x86_64/boot/bzImage -> ../../x86/boot/bzImage
```


- 内核编译
```shell
cd linux
make menuconfig # 配置内核

<!-- debug 相关 -->
Kernel hacking  --->
  Compile-time checks and compiler options  --->
    [*] Compile the kernel with debug info
    [*]   Provide GDB scripts for kernel debugging

<!-- 关闭内核地址空间布局随机化 -->
Processor type and features  --->
  [ ]   Randomize the address of the kernel image (KASLR)
  <!-- [ ] Randomize the kernel memory sections -->

-> Processor type and features
  -> Build a relocatable kernel
  [ ]   Randomize the address of the kernel image (KASLR)

<!-- 关闭签名验证 -->
-*- Cryptographic API  --->
  Certificates for signature checking  --->
    (debian/canonical-certs.pem) Additional X.509 keys for default system keyring

<!-- 构建内核 -->
make -j$(nproc)
<!-- 编译模块 -->
make modules - j4
<!-- 安装模块 -->
make modules_install -j4
```

- 打包
```shell
make rpm
```
