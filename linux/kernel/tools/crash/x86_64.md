# x86_64

![](imgs/x86_64.png)

![](imgs/x86_64-1.png)



Documentation/arch/x86/x86_64/mm.rst: 内存分布

参数传递：
    ≤6个参数：寄存器传递
    6个参数：额外参数通过栈传递（从右向左压栈）

栈对齐要求：
    函数入口时：RSP % 16 == 0
    调用前时刻：RSP % 16 == 8（因call压入8字节返回地址）

寄存器保留责任：
    类型	寄存器	责任方
    Caller-saved	RAX, RCX, RDX	调用者保存
    RSI, RDI, R8-R11	
    Callee-saved	RBX, RBP, R12-R15	被调用者保存

结构体传递：
    ≤16字节：拆分为寄存器传递
    16字节：通过栈传递（调用者分配空间）



通用寄存器 (general register)
通用寄存器是平时运行程序会使用到的寄存器，也是最多接触的寄存器
64-bit	32-bit	16-bit	8-bit (low)
RAX	EAX	AX	AL
RBX	EBX	BX	BL
RCX	ECX	CX	CL
RDX	EDX	DX	DL
RSI	ESI	SI	SIL
RDI	EDI	DI	DIL
RBP	EBP	BP	BPL
RSP	ESP	SP	SPL
R8	R8D	R8W	R8B
R9	R9D	R9W	R9B
R10	R10D	R10W	R10B
R11	R11D	R11W	R11B
R12	R12D	R12W	R12B
R13	R13D	R13W	R13B
R14	R14D	R14W	R14B
R15	R15D	R15W	R15B

其中16位的寄存器中，可以访问其高8位的数据
16-bit	8-bit (high)
AX	AH
BX	BH
CX	CH
DX	DH


- 64位的寄存器
rax：通常用于存储函数调用返回值或临时值
rsp：栈顶指针，指向栈的顶部
rdi：第一个入参
rsi：第二个入参
rdx：第三个入参
rcx：第四个入参
r8：第五个入参
r9：第六个入参
rbx：基址寄存器, 数据存储，遵循Callee Save原则
rbp：栈底指针(帧指针), 数据存储，遵循Callee Save原则
r12~r15：通用寄存器, 数据存储，遵循Callee Save原则
r10~r11：临时寄存器, 数据存储，遵循Caller Save原则

参数位置	整数/指针	浮点数	说明
第1参数	RDI	XMM0	
第2参数	RSI	XMM1	
第3参数	RDX	XMM2	
第4参数	RCX	XMM3	
第5参数	R8	XMM4	
第6参数	R9	XMM5	

- 32位寄存器
eax：通常用来执行加法，函数调用的返回值一般也放在这里面
ebx：数据存取
ecx：通常用作计数器，比如for循环
edx：暂不清楚
esp：栈顶指针，指向栈的顶部
ebp：栈底指针，指向栈的底部，通常用ebp+偏移量的形式来定位函数存放在栈中的局部变量
edi：字符串操作时，用于存放数据源的地址
esi：字符串操作时，用于存放目的地址的，和edi两个经常搭配一起使用，执行字符串的复制等操作

高地址
+-----------------+
| 参数7+          | ← 调用前压栈
| 参数8+          |
+-----------------+
| 返回地址        | ← call 指令压入 (8B)
+-----------------+
| 保存的RBP       | ← 函数入口: push %rbp (8B)
+-----------------+
| 局部变量        | ← sub $N, %rsp
| ...             |
+-----------------+
| 对齐填充        | (确保16字节对齐)
+-----------------+
低地址


```asm
	.file	"main.c"
	.text
	.globl	mul
	.type	mul, @function
mul:
.LFB0:
	.cfi_startproc
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	movl	%edi, -20(%rbp)
	movl	%esi, -24(%rbp)
	movl	-20(%rbp), %edx
	movl	-24(%rbp), %eax
	addl	%edx, %eax
	movl	%eax, -4(%rbp)
	movl	-4(%rbp), %eax
	popq	%rbp
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE0:
	.size	mul, .-mul
	.globl	sum
	.type	sum, @function
sum:
.LFB1:
	.cfi_startproc
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	subq	$56, %rsp
	movl	%edi, -36(%rbp)
	movl	%esi, -40(%rbp)
	movl	%edx, -44(%rbp)
	movl	%ecx, -48(%rbp)
	movl	%r8d, -52(%rbp)
	movl	%r9d, -56(%rbp)
	movl	-40(%rbp), %edx
	movl	-36(%rbp), %eax
	movl	%edx, %esi
	movl	%eax, %edi
	call	mul
	movl	%eax, -28(%rbp)
	movl	16(%rbp), %eax
	cltd
	idivl	24(%rbp)
	movl	%eax, -24(%rbp)
	movl	-36(%rbp), %eax
	subl	-40(%rbp), %eax
	movl	%eax, -20(%rbp)
	movl	-28(%rbp), %edx
	movl	-44(%rbp), %eax
	addl	%eax, %edx
	movl	-48(%rbp), %eax
	addl	%eax, %edx
	movl	-52(%rbp), %eax
	addl	%eax, %edx
	movl	-56(%rbp), %eax
	addl	%eax, %edx
	movl	16(%rbp), %eax
	addl	%eax, %edx
	movl	24(%rbp), %eax
	addl	%edx, %eax
	movl	%eax, -16(%rbp)
	movl	-16(%rbp), %edx
	movl	-28(%rbp), %eax
	addl	%edx, %eax
	movl	%eax, -12(%rbp)
	movl	$0, -8(%rbp)
	movl	$0, -4(%rbp)
	movl	-12(%rbp), %eax
	leave
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE1:
	.size	sum, .-sum
	.globl	main
	.type	main, @function
main:
.LFB2:
	.cfi_startproc
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	subq	$48, %rsp
	movl	$0, -36(%rbp)
	movl	$0, -32(%rbp)
	movl	$0, -28(%rbp)
	movl	$0, -24(%rbp)
	movl	-36(%rbp), %edx
	movl	-32(%rbp), %eax
	addl	%eax, %edx
	movl	-28(%rbp), %eax
	addl	%eax, %edx
	movl	-24(%rbp), %eax
	addl	%edx, %eax
	movl	%eax, -20(%rbp)
	movl	$4, -16(%rbp)
	movl	$8, -12(%rbp)
	movl	$8, -8(%rbp)
	pushq	$8
	pushq	$7
	movl	$6, %r9d
	movl	$5, %r8d
	movl	$4, %ecx
	movl	$3, %edx
	movl	$2, %esi
	movl	$1, %edi
	call	sum
	addq	$16, %rsp
	movl	%eax, -4(%rbp)
	movl	$0, %eax
	leave
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE2:
	.size	main, .-main
	.ident	"GCC: (GNU) 15.1.1 20250425"
	.section	.note.GNU-stack,"",@progbits
```
