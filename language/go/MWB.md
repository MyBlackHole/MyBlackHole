### 写屏障
屏障技术在本书指内存屏障（Memory Barrier）
它保障了代码描述中对内存的操作顺序 既不会在编译期被编译器进行调整，也不会在运行时被 CPU 的乱序执行所打乱， 是一种语言与语言用户间的契约。

1. 并行标记清理产生的问题
在没有用户态代码并发修改三色抽象的情况下，回收可以正常结束。但并发回收的根本问题在于， 用户态代码在回收过程中会并发的更新对象图，从而赋值器和回收器可能对对象图的结构产生不同的认知， 这时以一个固定的三色波面作为回收过程前进的边界则不再合理

我们不妨考虑赋值器的写操作，假设某个灰色对象 A 指向白色对象 B， 而此时赋值器并发的将黑色对象 C 指向（ref3）了白色对象 B， 并将灰色对象 A 对白色对象 B 的引用移除（ref2），则在继续扫描的过程中， 白色对象 B 永远不会被标记为黑色对象了（回收器不会重新扫描黑色对象）
进而产生被错误回收的对象 B，如图 1 所示
![[imgs/Pasted image 20230304113225.png]]
[图 1: 回收器正确性的破坏]

2. 弱三色不变性
垃圾回收器的正确性体现在：
    - 不应出现对象的丢失，也不应错误的回收还不需要回收的对象。 作为内存屏障的一种，写屏障（Write Barrier）是一个在并发垃圾回收器中才会出现的概念

可以证明，当以下两个条件同时满足时会破坏垃圾回收器的正确性 [Wilson, 1992]：
    - 条件 1: 赋值器修改对象图，导致某一黑色对象引用白色对象；
    - 条件 2: 从灰色对象出发，到达白色对象的、未经访问过的路径被赋值器破坏。

只要能够避免其中任何一个条件，则不会出现对象丢失的情况，因为：
    - 如果条件 1 被避免，则所有白色对象均被灰色对象引用，没有白色对象会被遗漏；
    - 如果条件 2 被避免，即便白色对象的指针被写入到黑色对象中，但从灰色对象出发，总存在一条没有访问过的路径，从而找到到达白色对象的路径，白色对象最终不会被遗漏。

我们不妨将三色不变性所定义的波面根据这两个条件进行削弱：
    - 当满足原有的三色不变性定义（或上面的两个条件都不满足时）的情况称为强三色不变性（strong tricolor invariant）
    - 当赋值器令黑色对象引用白色对象时（满足条件 1 时）的情况称为弱三色不变性（weak tricolor invariant）

当赋值器进一步破坏灰色对象到达白色对象的路径时（进一步满足条件 2 时），即打破弱三色不变性， 也就破坏了回收器的正确性；
或者说，在破坏强弱三色不变性时必须引入额外的辅助操作。 
弱三色不变形的好处在于：只要存在未访问的能够到达白色对象的路径，就可以将黑色对象指向白色对象。

3. 赋值器的颜色

如果我们考虑并发的用户态代码，回收器不允许同时停止所有赋值器， 就是涉及了存在的多个不同状态的赋值器。为了对概念加以明确，还需要换一个角度， 把回收器视为对象，把赋值器视为影响回收器这一对象的实际行为（即影响 GC 周期的长短）， 从而引入赋值器的颜色：

    - 黑色赋值器：已经由回收器扫描过，不会再次对其进行扫描。
    - 灰色赋值器：尚未被回收器扫描过，或尽管已经扫描过但仍需要重新扫描。

赋值器的颜色对回收周期的结束产生影响： 如果某种并发回收器允许灰色赋值器的存在，则必须在回收结束之前重新扫描对象图
如果重新扫描过程中发现了新的灰色或白色对象，回收器还需要对新发现的对象进行追踪， 但是在新追踪的过程中，赋值器仍然可能在其根中插入新的非黑色的引用，如此往复， 直到重新扫描过程中没有发现新的白色或灰色对象
于是，在允许灰色赋值器存在的算法，最坏的情况下， 回收器只能将所有赋值器线程停止才能完成其跟对象的完整扫描，也就是我们所说的 STW。

4. 新分配对象的颜色
新的分配过程会导致赋值器持有新分配对象的引用
可想而知我们需要为新产生的对象分配适当的颜色
可想而知，新分配对象的颜色会产生不同的影响：

    - 如果新分配的对象为黑色或者灰色，则赋值器直接将其视为无需回收的对象，写入堆中；
    - 如果新分配的对象为白色，则可以避免无意义的新对象保留到下一个垃圾回收的周期。

如果我们进一步思考，则能够发现，由于黑色赋值器由于已经被回收器扫描过， 不会再对其进行任何扫描，一旦其分配新的白色对象 则意味着会导致错误的回收
因此黑色赋值器不能产生白色对象， 除非赋值器能够保证分配的白色对象的引用能够被写入到灰色波面中， 但这实践起来并不容易
不难看出，为了简化实现复杂度，令新分配的对象为黑色通常是安全的


[写屏障技术](https://golang.design/under-the-hood/zh-cn/part2runtime/ch08gc/barrier/)
